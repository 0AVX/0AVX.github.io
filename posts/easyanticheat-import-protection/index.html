<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Dethroning the Jungle King: EasyAntiCheat&#39;s Import Protection :: AVX&#39;s Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Brace yourself for an extraordinary expedition into the heart of the impenetrable jungle, where the reigning monarch of protection, EasyAntiCheat, conceals its cunning secrets. In this riveting article, we navigate through the treacherous terrain of their import protection, peeling back the layers of its throne to reveal the elusive strategies that have kept cheaters at bay." />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="/posts/easyanticheat-import-protection/" />






  
  
  
  
  
  <link rel="stylesheet" href="/styles.css">







  <link rel="shortcut icon" href="/img/theme-colors/pink.png">
  <link rel="apple-touch-icon" href="/img/theme-colors/pink.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Dethroning the Jungle King: EasyAntiCheat&#39;s Import Protection">
<meta property="og:description" content="Brace yourself for an extraordinary expedition into the heart of the impenetrable jungle, where the reigning monarch of protection, EasyAntiCheat, conceals its cunning secrets. In this riveting article, we navigate through the treacherous terrain of their import protection, peeling back the layers of its throne to reveal the elusive strategies that have kept cheaters at bay." />
<meta property="og:url" content="/posts/easyanticheat-import-protection/" />
<meta property="og:site_name" content="AVX&#39;s Blog" />

  
    <meta property="og:image" content="/img/favicon/pink.png">
  

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2023-07-17 00:00:00 &#43;0000 UTC" />












</head>
<body class="pink">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    AVX&#39;s Blog
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;â–¾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/about">About</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="/posts/easyanticheat-import-protection/">Dethroning the Jungle King: EasyAntiCheat&rsquo;s Import Protection</a>
  </h1>
  <div class="post-meta">
    
      <time class="post-date">
        2023-07-17 ::
        
      </time>
    
    
      <span class="post-author">AVX</span>
    
    
  </div>

  
  


  

  <div class="post-content"><div>
        <h1 id="disclaimer">Disclaimer<a href="#disclaimer" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>The information provided in this document is intended <strong>solely for educational and informational purposes</strong>. It is <strong>not meant to belittle EasyAntiCheat</strong> or any individuals involved in its development or implementation. Rather, it aims to shed light on the internal workings of EasyAntiCheat so that consumers can better understand what happens behind the scenes when playing their favorite games. Any opinions expressed herein <strong>do not necessarily reflect those of EasyAntiCheat</strong> or any other parties mentioned. This document is provided &ldquo;<strong>as is</strong>&rdquo; without warranty of any kind, either express or implied, including but not limited to the implied warranties of merchantability and fitness for a particular purpose. I shall not be liable for any damages whatsoever arising out of or in connection with the use of this document.</p>
<h1 id="introduction">Introduction<a href="#introduction" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>In the ever-evolving virtual battlegrounds, where the quest for fair play clashes with cunning cheaters, an enigmatic sentinel, EasyAntiCheat, reigns supreme, concealing its guarded export resolving strategies. This gripping journey takes us deep into the heart of its jungle-like defenses, as we endeavor to dethrone the Jungle King, exposing the hidden mechanisms, unlocking the secrets of their superior technology.</p>
<p>Armed with inquisitiveness and technical prowess, we embark on an enthralling expedition to shed light on the protected imports, unraveling the captivating tale of EasyAntiCheat&rsquo;s silent prowess in safeguarding the integrity of online gaming.</p>
<h1 id="before-we-dive-in-getting-the-basics-right">Before We Dive In: Getting the Basics Right<a href="#before-we-dive-in-getting-the-basics-right" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>To proceed with the remaining part of the article, I recommend first addressing these topics:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=DRH0oRFwFiM">Virtualization-Based Obfuscators</a></li>
<li><a href="http://sandsprite.com/CodeStuff/Understanding_imports.html">Understanding the Import Address Table</a></li>
<li><a href="https://dev.to/wireless90/exploring-the-export-table-windows-pe-internals-4l47">Exploring the Export Table</a></li>
</ul>
<h1 id="the-problem">The Problem<a href="#the-problem" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Dynamic analysis plays a crucial role in understanding the behavior of code, especially when dealing with reverse engineering. Anticheats, such as EasyAntiCheat, have recognized the importance of this approach and actively develop methods to mitigate against such attacks.</p>
<p>One of the primary methods for understanding behavior is by observing calls to imported functions. Typically, these functions can be found in the application&rsquo;s IAT, which is resolved during the application&rsquo;s construction phase.</p>
<p>However, relying on the IAT for security products is considered quite an insecure design. To address this issue, one can reproduce the behavior by manually parsing the EAT and resolving imports themselves, which eliminates the need for using the IAT.</p>
<p>In the case of EasyAntiCheat, they have implemented this solution by employing a safeguarded virtualized routine, which attempts to securely resolve their needed exports, and also inlining decryption for the callers of the <code>DecryptImport</code> function.</p>
<p>Furthermore, on top of the inlined decryption, they are also employing encryption that utilizes a public and private key, with the private key being discarded at runtime.</p>
<p>With the use of this method, it becomes nearly impossible to recover the aforementioned private key or to overwrite the import with another value.</p>
<h1 id="spying-on-the-king-real-world-examples">Spying on the King: Real World Examples<a href="#spying-on-the-king-real-world-examples" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>To kick things off, and before approaching the Jungle, let&rsquo;s examine some examples which are used in other applications.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> VgkExports<span style="color:#f92672">::</span>ExEnumHandleTable(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  v17.m128i_i64[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3DC8C9558A64BA8A</span>i64;
</span></span><span style="display:flex;"><span>  v18.m128i_i64[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xD6EBDD7A0CEE792Bu</span>i64;
</span></span><span style="display:flex;"><span>  v19.m128i_i64[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3DC8C9558A64BA8A</span>i64;
</span></span><span style="display:flex;"><span>  v18.m128i_i64[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xD6C6BCCF590828A8u</span>i64;
</span></span><span style="display:flex;"><span>  v1 <span style="color:#f92672">=</span> _mm_load_si128(<span style="color:#f92672">&amp;</span>v18);
</span></span><span style="display:flex;"><span>  v19.m128i_i64[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xC7884760EDC680EDu</span>i64;
</span></span><span style="display:flex;"><span>  v16.m128i_i64[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xB7A3B00F62AB016Eu</span>i64;
</span></span><span style="display:flex;"><span>  v16.m128i_i64[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xBAA4DD9B3C644CC6u</span>i64;
</span></span><span style="display:flex;"><span>  v17.m128i_i64[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xC7884760EDC68088u</span>i64;
</span></span><span style="display:flex;"><span>  v2 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">__int64</span> <span style="color:#f92672">**</span>)a1;
</span></span><span style="display:flex;"><span>  v17 <span style="color:#f92672">=</span> _mm_xor_si128(v17, v19);
</span></span><span style="display:flex;"><span>  v16 <span style="color:#f92672">=</span> _mm_xor_si128(v1, v16);
</span></span><span style="display:flex;"><span>  Export <span style="color:#f92672">=</span> FindExport(<span style="color:#f92672">*</span>v2, v16.m128i_i8, <span style="color:#ae81ff">0</span>i64, <span style="color:#ae81ff">0</span>i64);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* redacted code */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> Export;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If you&rsquo;ve ever worked with VGK before, then you&rsquo;ll immediately notice these stubs spread throughout their binary.</p>
<p>The process is relatively straightforward:</p>
<ul>
<li>They start by constructing the string on the stack, applying XOR to obfuscate it, and calling <code>FindExport</code>.</li>
<li><code>FindExport</code> then takes the provided base address as the first argument and locates the EAT from that address.</li>
<li>Lastly, <code>FindExport</code> iterates through the EAT and compares the provided name with the names of exports to find a match.</li>
</ul>
<p>If you need further clarification on this technique, then I recommend exploring Justas Masiulis&rsquo; <a href="https://github.com/JustasMasiulis/lazy_importer">Lazy Importer</a>, which expands on the concept by employing a hash instead of a decryptable string, which improves the level of obfuscation and security.</p>
<h1 id="approaching-the-jungle-the-inlined-decryption">Approaching the Jungle: The Inlined Decryption<a href="#approaching-the-jungle-the-inlined-decryption" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>As we know, EasyAntiCheat takes great pride in protecting against reverse engineering attempts, as can be seen from their new obfuscator.</p>
<p>So, instead of applying just one layer of encryption to the import addresses, they have opted to add another layer, known as their inlined decryption.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v16 <span style="color:#f92672">=</span> DecryptImport(qword_125B00);
</span></span><span style="display:flex;"><span>((<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span> <span style="color:#f92672">*</span>)(<span style="color:#66d9ef">__int64</span>))(__ROL8__(v16, <span style="color:#ae81ff">29</span>) <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x3A505A07B9BA3B9E</span>i64))(v15);
</span></span></code></pre></div><p>Just as the name suggests, each caller to the <code>DecryptImport</code> function decrypts the second layer.</p>
<p>This is quite a play on their part as it makes it rather difficult to hook imports without knowing the decryption algorithm.</p>
<p>Of course, one can simply just employ an assembly disassembler and automatically resolve the constants used for decryption.</p>
<p>While this method certainly performs well in most scenarios, it proves to be a great challenge in functions that leverage obfuscation.</p>
<p>Another feasible approach would be to capture the context after returning to the obfuscated code from <code>DecryptImport</code> and emulate until the decryption has completed.</p>
<p>However, where&rsquo;s the fun in doing that?</p>
<h1 id="approaching-the-jungle-the-main-decryption">Approaching the Jungle: The Main Decryption<a href="#approaching-the-jungle-the-main-decryption" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">uint64_t</span> <span style="color:#a6e22e">DecryptImport</span>( <span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">*</span> PublicKeys )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> First  <span style="color:#f92672">=</span> DecryptFirst( PublicKeys[ <span style="color:#ae81ff">0</span> ] );
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> Second <span style="color:#f92672">=</span> DecryptSecond( PublicKeys[ <span style="color:#ae81ff">1</span> ] ) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">32</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> First <span style="color:#f92672">|</span> Second;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Based on both of these reversed snippets, I can infer what the encryption process may look like:</p>
<ul>
<li>Iterate and find the export in a driver&rsquo;s EAT.</li>
<li>Apply the inlined encryption to the result.</li>
<li>Apply the main encryption to the result.</li>
<li>Write both public keys to the designated region.</li>
</ul>
<h1 id="entering-the-jungle-setting-the-traps">Entering the Jungle: Setting the Traps<a href="#entering-the-jungle-setting-the-traps" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>With that out of the way, I started my analysis by setting a write trap on the public keys of a random encrypted import in the <code>.data</code> section.</p>
<p>This enabled me to see what I was dealing with and continue reversing from there.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>AddEptHook_Range( EacBase <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x125B00</span>, EacBase <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x125B08</span>, HvDebugger<span style="color:#f92672">::</span>HvAccess<span style="color:#f92672">::</span>Write, 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">+</span>[ ]( HvDebugger<span style="color:#f92672">::</span>HvContext<span style="color:#f92672">*</span> Context, <span style="color:#66d9ef">uint64_t</span> Address, <span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">&amp;</span> Pfn ) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    WriteLog( <span style="color:#e6db74">&#34;WriteTrap&#34;</span>, TraceLoggingHexUInt64( EAC_BASE( Context<span style="color:#f92672">-&gt;</span>Rip ), <span style="color:#e6db74">&#34;RipRva&#34;</span> ), TraceLoggingHexUInt64( EAC_BASE( Address ), <span style="color:#e6db74">&#34;AddrRva&#34;</span> ) );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>} );
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;RipRva&#34;</span>:<span style="color:#e6db74">&#34;0x91FB7E&#34;</span>, <span style="color:#f92672">&#34;AddrRva&#34;</span>:<span style="color:#e6db74">&#34;0x125B00&#34;</span> }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;RipRva&#34;</span>:<span style="color:#e6db74">&#34;0xD1C721&#34;</span>, <span style="color:#f92672">&#34;AddrRva&#34;</span>:<span style="color:#e6db74">&#34;0x125B08&#34;</span> }
</span></span></code></pre></div><p>There were two other writes, but these are used (and read) before the export is found, so I didn&rsquo;t mention them here.</p>
<p>After looking at these addresses, it&rsquo;s pretty obvious that it&rsquo;s coming from a virtualized function, which was my initial anticipation.</p>
<h1 id="entering-the-jungle-following-the-river">Entering the Jungle: Following the River<a href="#entering-the-jungle-following-the-river" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Since I was now analyzing a virtualized routine, specifically a <code>VMWRITE</code> handler, I figured that I&rsquo;d take a look at the stack as interesting stuff that could be useful to our investigation may be present on it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">*</span> Stack <span style="color:#f92672">=</span> ( <span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">*</span> )Context<span style="color:#f92672">-&gt;</span>Rsp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ( size_t Idx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; Idx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">200</span>; Idx<span style="color:#f92672">++</span> )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> Value <span style="color:#f92672">=</span> Stack[ Idx ];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( Value <span style="color:#f92672">&amp;&amp;</span> IN_EAC( Value ) )
</span></span><span style="display:flex;"><span>        WriteLog( <span style="color:#e6db74">&#34;StackDump&#34;</span>, TraceLoggingHexUInt64( Idx ), TraceLoggingHexUInt64( EAC_BASE( Value ), <span style="color:#e6db74">&#34;Rva&#34;</span> ) );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x0&#34;</span>,  <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x125B00&#34;</span> } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">Trap</span> <span style="color:#960050;background-color:#1e0010">Location</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x23&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x6F4E4&#34;</span>  }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x24&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x6F4E4&#34;</span>  }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x25&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x6F598&#34;</span>  }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x4B&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x66698C&#34;</span> }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x4D&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x125B00&#34;</span> } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">Trap</span> <span style="color:#960050;background-color:#1e0010">Location</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x52&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x18F9E4&#34;</span> } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">DriverEntry</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x63&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x18FAC0&#34;</span> }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x65&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x18FA80&#34;</span> }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x6D&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x74F8E2&#34;</span> }
</span></span></code></pre></div><p>After quickly looking at the results, I noticed that <code>0x18F9E4</code> was the <code>DriverEntry</code> function, and so everything after that could be easily disregarded.</p>
<p>Another thing that can be disregarded is <code>0x125B00</code>, which is the address that I set the trap to in the first place.</p>
<p>After removing duplicates, I was left with the following results:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x23&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x6F4E4&#34;</span>  }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x25&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x6F598&#34;</span>  }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x4B&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x66698C&#34;</span> }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">sub_6F4E4</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> a1, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> a2, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> a3)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v3; <span style="color:#75715e">// r9
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> i; <span style="color:#75715e">// r8
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v3 <span style="color:#f92672">=</span> a3;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>i64; a1; v3 <span style="color:#f92672">=</span> v3 <span style="color:#f92672">*</span> (<span style="color:#66d9ef">unsigned</span> __int128)v3 <span style="color:#f92672">%</span> a2 )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( (a1 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>      i <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span>)i <span style="color:#f92672">*</span> (<span style="color:#66d9ef">unsigned</span> __int128)v3 <span style="color:#f92672">%</span> a2;
</span></span><span style="display:flex;"><span>    a1 <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> i;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Just from looking at the general structure of this function, it reminded me of the initial <code>DecryptImport</code> routine which we went over earlier.</p>
<p>However, it was quite odd that they&rsquo;d be decrypting the imports before they were even written.</p>
<p>So, judging by the arguments, and after setting a breakpoint and dumping the registers, it became obvious that this routine is actually used to apply the main encryption to each respective import.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Rcx&#34;</span>:<span style="color:#e6db74">&#34;0x35375306D545459&#34;</span>,  <span style="color:#f92672">&#34;Rdx&#34;</span>:<span style="color:#e6db74">&#34;0x12D8ED6858CD15B7&#34;</span>, <span style="color:#f92672">&#34;R8&#34;</span>:<span style="color:#e6db74">&#34;0xA588E17A&#34;</span> }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Rcx&#34;</span>:<span style="color:#e6db74">&#34;0x1D34200DE5B033A1&#34;</span>, <span style="color:#f92672">&#34;Rdx&#34;</span>:<span style="color:#e6db74">&#34;0x237626ED2C9C28F3&#34;</span>, <span style="color:#f92672">&#34;R8&#34;</span>:<span style="color:#e6db74">&#34;0x20FAECB8&#34;</span> }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Rcx&#34;</span>:<span style="color:#e6db74">&#34;0x35375306D545459&#34;</span>,  <span style="color:#f92672">&#34;Rdx&#34;</span>:<span style="color:#e6db74">&#34;0x12D8ED6858CD15B7&#34;</span>, <span style="color:#f92672">&#34;R8&#34;</span>:<span style="color:#e6db74">&#34;0x63558ACF&#34;</span> }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Rcx&#34;</span>:<span style="color:#e6db74">&#34;0x1D34200DE5B033A1&#34;</span>, <span style="color:#f92672">&#34;Rdx&#34;</span>:<span style="color:#e6db74">&#34;0x237626ED2C9C28F3&#34;</span>, <span style="color:#f92672">&#34;R8&#34;</span>:<span style="color:#e6db74">&#34;0xAD8C5A8&#34;</span>  }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Rcx&#34;</span>:<span style="color:#e6db74">&#34;0x35375306D545459&#34;</span>,  <span style="color:#f92672">&#34;Rdx&#34;</span>:<span style="color:#e6db74">&#34;0x12D8ED6858CD15B7&#34;</span>, <span style="color:#f92672">&#34;R8&#34;</span>:<span style="color:#e6db74">&#34;0x30696C03&#34;</span> }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Rcx&#34;</span>:<span style="color:#e6db74">&#34;0x1D34200DE5B033A1&#34;</span>, <span style="color:#f92672">&#34;Rdx&#34;</span>:<span style="color:#e6db74">&#34;0x237626ED2C9C28F3&#34;</span>, <span style="color:#f92672">&#34;R8&#34;</span>:<span style="color:#e6db74">&#34;0x46D4F31E&#34;</span> }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Rcx&#34;</span>:<span style="color:#e6db74">&#34;0x35375306D545459&#34;</span>,  <span style="color:#f92672">&#34;Rdx&#34;</span>:<span style="color:#e6db74">&#34;0x12D8ED6858CD15B7&#34;</span>, <span style="color:#f92672">&#34;R8&#34;</span>:<span style="color:#e6db74">&#34;0xCFBFE39F&#34;</span> }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Rcx&#34;</span>:<span style="color:#e6db74">&#34;0x1D34200DE5B033A1&#34;</span>, <span style="color:#f92672">&#34;Rdx&#34;</span>:<span style="color:#e6db74">&#34;0x237626ED2C9C28F3&#34;</span>, <span style="color:#f92672">&#34;R8&#34;</span>:<span style="color:#e6db74">&#34;0xBB301A01&#34;</span> }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Rcx&#34;</span>:<span style="color:#e6db74">&#34;0x35375306D545459&#34;</span>,  <span style="color:#f92672">&#34;Rdx&#34;</span>:<span style="color:#e6db74">&#34;0x12D8ED6858CD15B7&#34;</span>, <span style="color:#f92672">&#34;R8&#34;</span>:<span style="color:#e6db74">&#34;0xD4D49738&#34;</span> }
</span></span></code></pre></div><p>Yet again, this reminded me of the initial <code>DecryptImport</code> function, as <code>RDX</code>, which represents the public key, was exactly the same.</p>
<p>This function is being called twice, with each public and private key, on the inline encrypted values, which is represented using <code>R8</code>.</p>
<p>The next function on the list, namely <code>0x6F598</code>, had also piqued my interest during the investigation.</p>
<p>Much like the previous function, I also dumped the registers and noticed something rather interesting about the registers at hand.</p>
<p>When I looked at the registers, <code>RCX</code> was the only interesting one, as it pointed to <code>0x1861D0</code>, which was an empty region in the <code>.data</code> section.</p>
<p>I decided to continue searching for anything else that was interesting and kept this address in mind.</p>
<p>Lastly, I was left with a <code>VMCALL</code> handler, which after some quick analysis, didn&rsquo;t turn out useful.</p>
<h1 id="entering-the-jungle-the-kings-den">Entering the Jungle: The King&rsquo;s Den<a href="#entering-the-jungle-the-kings-den" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>To gather some more information and determine how they were comparing the names, I decided to set a read trap on <code>NtGlobalFlag</code>&rsquo;s name in <code>ntoskrnl.exe</code>&rsquo;s EAT, as I already knew that they&rsquo;re using this import.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>AddEptHook( Utils<span style="color:#f92672">::</span>GetExportName( <span style="color:#e6db74">&#34;NtGlobalFlag&#34;</span> ), HvDebugger<span style="color:#f92672">::</span>HvAccess<span style="color:#f92672">::</span>Read, 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">+</span>[ ]( HvDebugger<span style="color:#f92672">::</span>HvContext<span style="color:#f92672">*</span> Context, <span style="color:#66d9ef">uint64_t</span> Address, <span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">&amp;</span> Pfn ) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    WriteLog( <span style="color:#e6db74">&#34;ReadTrap&#34;</span>, TraceLoggingHexUInt64( EAC_BASE( Context<span style="color:#f92672">-&gt;</span>Rip ), <span style="color:#e6db74">&#34;Rva&#34;</span> ) );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">*</span> Stack <span style="color:#f92672">=</span> ( <span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">*</span> )Context<span style="color:#f92672">-&gt;</span>Rsp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> ( size_t Idx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; Idx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">200</span>; Idx<span style="color:#f92672">++</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">uint64_t</span> Value <span style="color:#f92672">=</span> Stack[ Idx ];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( Value <span style="color:#f92672">&amp;&amp;</span> IN_EAC( Value ) )
</span></span><span style="display:flex;"><span>            WriteLog( <span style="color:#e6db74">&#34;StackDump&#34;</span>, TraceLoggingHexUInt64( Idx ), TraceLoggingHexUInt64( EAC_BASE( Value ), <span style="color:#e6db74">&#34;Rva&#34;</span> ) );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>} );
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x2FE234&#34;</span>               } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">Read</span> <span style="color:#960050;background-color:#1e0010">Handler</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x4637B&#34;</span>                } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">SHA</span><span style="color:#ae81ff">1</span> <span style="color:#960050;background-color:#1e0010">Read</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0xF&#34;</span>,  <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x6B09A5&#34;</span> } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">SHA</span><span style="color:#ae81ff">1</span> <span style="color:#960050;background-color:#1e0010">Caller</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x13&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x463AC&#34;</span>  } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">SHA</span><span style="color:#ae81ff">1</span> <span style="color:#960050;background-color:#1e0010">Function</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x1E&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x125600&#34;</span> } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">Export</span> <span style="color:#960050;background-color:#1e0010">Keys</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x1F&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x6F584&#34;</span>  } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">Placeholder</span> <span style="color:#960050;background-color:#1e0010">Function</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x3A&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x1861D0&#34;</span> } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">Chunk</span> <span style="color:#960050;background-color:#1e0010">in</span> <span style="color:#960050;background-color:#1e0010">.data</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x3D&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x924C56&#34;</span> }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x67&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x66698C&#34;</span> } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">Useless</span> <span style="color:#960050;background-color:#1e0010">Function</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x69&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x1260F8&#34;</span> } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">Random</span> <span style="color:#960050;background-color:#1e0010">Export</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x6E&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x18F9E4&#34;</span> } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">DriverEntry</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x7F&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x18FAC0&#34;</span> }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x81&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x18FA80&#34;</span> }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Idx&#34;</span>:<span style="color:#e6db74">&#34;0x89&#34;</span>, <span style="color:#f92672">&#34;Rva&#34;</span>:<span style="color:#e6db74">&#34;0x74F8E2&#34;</span> }
</span></span></code></pre></div><p>That&rsquo;s exciting to see! They were still relying on their SHA1 algorithm to read and compare the names of exports, which I noticed from the distinct constants that are used in the SHA1 context.</p>
<p>Since the SHA1 routine was provided with the length, and the initial reading handlers were reading all of the bytes in the name, I came to the conclusion that it was an inlined <code>strlen</code>, which was virtualized.</p>
<p>Just like before, I removed the useless entries that are labeled, which left me with a single entry: <code>0x924C56</code>.</p>
<p>It&rsquo;s also important to note that, yet again, <code>0x1861D0</code> appears, so I deemed it quite important.</p>
<p>Now, given that the entry was a <code>VMCALL</code> instruction, I dumped the destination and registers alike.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>AddEptHook( EacBase <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x924C52</span>, HvDebugger<span style="color:#f92672">::</span>HvAccess<span style="color:#f92672">::</span>Execute, 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">+</span>[ ]( HvDebugger<span style="color:#f92672">::</span>HvContext<span style="color:#f92672">*</span> Context, <span style="color:#66d9ef">uint64_t</span> Address, <span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">&amp;</span> Pfn ) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      seg007:0000000000924C4B add rsp, 110h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      seg007:0000000000924C52 call qword ptr [rsp+8]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      seg007:0000000000924C56 sub rsp, 110h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> Function <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>( <span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">*</span> )( Context<span style="color:#f92672">-&gt;</span>Rsp <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span> );
</span></span><span style="display:flex;"><span>    WriteLog( <span style="color:#e6db74">&#34;Vmcall&#34;</span>, TraceLoggingHexUInt64( EAC_BASE( Function ), <span style="color:#e6db74">&#34;Function&#34;</span> ) );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    HvDebugger<span style="color:#f92672">::</span>DumpRegisters( Context );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>} );
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Function&#34;</span>:<span style="color:#e6db74">&#34;0x72E98&#34;</span>                       }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Name&#34;</span>:<span style="color:#e6db74">&#34;RCX&#34;</span>, <span style="color:#f92672">&#34;Value&#34;</span>:<span style="color:#e6db74">&#34;0xFFFF8E8BAE7255E0&#34;</span> }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Name&#34;</span>:<span style="color:#e6db74">&#34;RDX&#34;</span>, <span style="color:#f92672">&#34;Value&#34;</span>:<span style="color:#e6db74">&#34;0xFFFFF80706E00000&#34;</span> } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">Ntoskrnl</span> <span style="color:#960050;background-color:#1e0010">Base</span> <span style="color:#960050;background-color:#1e0010">Address</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Name&#34;</span>:<span style="color:#e6db74">&#34;R8&#34;</span>,  <span style="color:#f92672">&#34;Value&#34;</span>:<span style="color:#e6db74">&#34;0xFFFF8E8BAE7256C0&#34;</span> }
</span></span></code></pre></div><p>Awesome, this was exactly the function that I was looking for, which I deemed as <code>InitializeImports</code>!</p>
<p>This function, in fact, was called for every module that EasyAntiCheat wanted to initialize protected imports for, and was provided with the base address.</p>
<p>After further analysis, the function&rsquo;s parameters are as follows:</p>
<ul>
<li><code>RCX</code>: A pointer to both public keys.</li>
<li><code>RDX</code>: The module&rsquo;s base address.</li>
<li><code>R8</code>: A pointer to an integer that was written the number of resolved imports, which was determinated by logging writes, and observing the integer increasing when an import was resolved.</li>
</ul>
<p>While this is definitely all useful information, I still had the question: how did they know which imports to find?</p>
<p>As I mentioned previously, none of the registers contained anything that held this information.</p>
<p>But then I thought of something: what if they were writing it to <code>0x1861D0</code>?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>AddEptHook( EacBase <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1861D0</span>, HvDebugger<span style="color:#f92672">::</span>HvAccess<span style="color:#f92672">::</span>Read,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">+</span>[ ]( HvDebugger<span style="color:#f92672">::</span>HvContext<span style="color:#f92672">*</span> Context, <span style="color:#66d9ef">uint64_t</span> Address, <span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">&amp;</span> Pfn )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>		WriteLog( <span style="color:#e6db74">&#34;ReadTrap&#34;</span>, TraceLoggingString( Symbolize( Context<span style="color:#f92672">-&gt;</span>Rip ), <span style="color:#e6db74">&#34;Name&#34;</span> ) );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> false;	
</span></span><span style="display:flex;"><span>} );
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Name&#34;</span>:<span style="color:#e6db74">&#34;EasyAntiCheat_EOS.sys+0x73228&#34;</span>  } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">Sorting</span> <span style="color:#960050;background-color:#1e0010">Function</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Name&#34;</span>:<span style="color:#e6db74">&#34;ntoskrnl.exe+0x3D0A9A&#34;</span>          } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">qsort</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Name&#34;</span>:<span style="color:#e6db74">&#34;ntoskrnl.exe+0x3D0AD3&#34;</span>          } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">qsort</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Name&#34;</span>:<span style="color:#e6db74">&#34;EasyAntiCheat_EOS.sys+0x7322B&#34;</span>  } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">Sorting</span> <span style="color:#960050;background-color:#1e0010">Function</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Name&#34;</span>:<span style="color:#e6db74">&#34;ntoskrnl.exe+0x3D0A23&#34;</span>          } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">qsort</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Name&#34;</span>:<span style="color:#e6db74">&#34;EasyAntiCheat_EOS.sys+0x21F118&#34;</span> } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">Reading</span> <span style="color:#960050;background-color:#1e0010">Handler</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Name&#34;</span>:<span style="color:#e6db74">&#34;EasyAntiCheat_EOS.sys+0x855527&#34;</span> } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">Reading</span> <span style="color:#960050;background-color:#1e0010">Handler</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Name&#34;</span>:<span style="color:#e6db74">&#34;EasyAntiCheat_EOS.sys+0x425042&#34;</span> } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">Reading</span> <span style="color:#960050;background-color:#1e0010">Handler</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Name&#34;</span>:<span style="color:#e6db74">&#34;EasyAntiCheat_EOS.sys+0x86D2BC&#34;</span> } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">Reading</span> <span style="color:#960050;background-color:#1e0010">Handler</span>
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Name&#34;</span>:<span style="color:#e6db74">&#34;EasyAntiCheat_EOS.sys+0x425042&#34;</span> } <span style="color:#960050;background-color:#1e0010">&lt;--</span> <span style="color:#960050;background-color:#1e0010">Reading</span> <span style="color:#960050;background-color:#1e0010">Handler</span>
</span></span></code></pre></div><p>This was quite interesting, as sorting them is definitely smart on their end, as it allows for faster iteration later on.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>AddEptHook( Utils<span style="color:#f92672">::</span>GetExport( <span style="color:#e6db74">&#34;qsort&#34;</span> ), HvDebugger<span style="color:#f92672">::</span>HvAccess<span style="color:#f92672">::</span>Execute,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">+</span>[ ]( HvDebugger<span style="color:#f92672">::</span>HvContext<span style="color:#f92672">*</span> Context, uintptr_t Address, <span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">&amp;</span> Pfn )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> ReturnAddress <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>( <span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">*</span> )Context<span style="color:#f92672">-&gt;</span>Rsp;  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>IN_EAC( ReturnAddress ) )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Utils<span style="color:#f92672">::</span>DumpArray( <span style="color:#f92672">&amp;</span>FormatElements, Context<span style="color:#f92672">-&gt;</span>Gpr<span style="color:#f92672">-&gt;</span>rcx <span style="color:#75715e">/* Base of Elements */</span>, Context<span style="color:#f92672">-&gt;</span>Gpr<span style="color:#f92672">-&gt;</span>rdx <span style="color:#75715e">/* Number of Elements */</span>, Context<span style="color:#f92672">-&gt;</span>Gpr<span style="color:#f92672">-&gt;</span>r8 <span style="color:#75715e">/* Size of Elements */</span> );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> false;	
</span></span><span style="display:flex;"><span>} );
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Sort&#34;</span>:<span style="color:#e6db74">&#34;0x6556BC1D6053223C&#34;</span>, <span style="color:#f92672">&#34;InlinedKey&#34;</span>:<span style="color:#e6db74">&#34;0x65091738C0592277&#34;</span>, <span style="color:#f92672">&#34;Export&#34;</span>:<span style="color:#e6db74">&#34;0x1263E8&#34;</span>, <span style="color:#f92672">&#34;Default&#34;</span>:<span style="color:#e6db74">&#34;0x6F584&#34;</span> }
</span></span><span style="display:flex;"><span>{ <span style="color:#f92672">&#34;Sort&#34;</span>:<span style="color:#e6db74">&#34;0x386399B9B0FD723E&#34;</span>, <span style="color:#f92672">&#34;InlinedKey&#34;</span>:<span style="color:#e6db74">&#34;0xF26FB57ABCF6FADF&#34;</span>, <span style="color:#f92672">&#34;Export&#34;</span>:<span style="color:#e6db74">&#34;0x126408&#34;</span>, <span style="color:#f92672">&#34;Default&#34;</span>:<span style="color:#e6db74">&#34;0x6F584&#34;</span> }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ProtectedImportData</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> Sort;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> InlinedKey;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span><span style="color:#f92672">*</span> PublicKeys;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint64_t</span> Default;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>This dump was much larger, but I condensed it for readability.</p>
</blockquote>
<p>My suspicions were correct, as EasyAntiCheat is indeed temporarily storing the import data here, and wiping it after they&rsquo;ve encrypted their imports.</p>
<p>Another interesting thing is that, if the import couldn&rsquo;t be resolved, they resort to using default values instead, which I noticed after looking at the default values in IDA.</p>
<p>On a final note, EasyAntiCheat also uses <code>RtlPcToFileHeader</code>, on itself, to locate the base address for <code>ntoskrnl.exe</code>. The base address is then encrypted, and stored, within the <code>.data</code> section, with a boolean to say that it was found.</p>
<h1 id="leaving-the-jungle-winning-the-battle">Leaving the Jungle: Winning the Battle<a href="#leaving-the-jungle-winning-the-battle" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>In conclusion, EasyAntiCheat has opted for quite an effective method in dealing with hardening against reverse engineering attempts.</p>
<p>However, like with anything in this field, it is subject to being analyzed.</p>
<p>As per usual, I have left an exercise for the reader, which you will quickly notice when attempting to generate decryption stubs for the imports.</p>
<p>Until next time!</p>

      </div></div>

  
    
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        
        <span class="button next">
            <a href="/posts/easyanticheat-eprocess-emulation/">
                <span class="button__text">The Unseen Guardian: EasyAntiCheatâ€™s EProcess Emulation</span>
                <span class="button__icon">â†’</span>
            </a>
        </span>
        
    </div>
</div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Â© 2023 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
